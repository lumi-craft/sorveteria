<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorveteria PRO - Mobile & PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --pink: #ff85a2; --pink-dark: #ef6281; --blue: #0984e3; --green: #27ae60;
            --dark: #2d3436; --gray-bg: #f5f6fa; --border: #dcdde1; --white: #ffffff;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--gray-bg); color: var(--dark); overflow: hidden; }

        /* Layout Responsivo e Estrutura */
        #sidebar { width: 350px; background: var(--white); border-right: 2px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .header-box { padding: 20px; background: var(--dark); color: white; text-align: center; }
        #lista-comandas { flex-grow: 1; overflow-y: auto; padding: 15px; }
        
        .aba-comanda { 
            padding: 15px; background: white; border: 1px solid var(--border); border-radius: 10px; 
            margin-bottom: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .aba-comanda.ativa { border-left: 10px solid var(--pink); background: #fff5f7; border-color: var(--pink); }

        #workspace { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; height: 100vh; }
        #view-comanda { display: none; flex-direction: column; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
        
        .grid-produtos { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-prod { background: white; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; font-weight: bold; }

        #detalhes-comanda { background: white; border-radius: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        #itens-carrinho { flex-grow: 1; overflow-y: auto; padding: 15px; background: #fafafa; }
        .item-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }

        .footer-comanda { padding: 15px; background: white; border-top: 2px solid #f1f1f1; }
        .display-total { font-size: 2rem; font-weight: 800; display: flex; justify-content: space-between; margin-bottom: 10px; }

        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-pink { background: var(--pink); color: white; }
        .btn-green { background: var(--green); color: white; width: 100%; }
        .btn-red { background: #ff7675; color: white; }
        .btn-gray { background: #dfe6e9; color: var(--dark); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid var(--border); border-radius: 10px; }

        /* Estilo do Relat√≥rio para o PDF */
        #relatorio-pdf { padding: 20px; background: white; color: black; font-family: Arial, sans-serif; }
        .oculto { display: none; }
    </style>
</head>
<body>

    <div id="modal-senha" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--pink-dark); margin-top:0;">üîí Autoriza√ß√£o</h2>
            <input type="password" id="campo-senha-cancelar" placeholder="Senha de Cancelamento">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-red" onclick="validarCancelamento()" style="flex:1">Confirmar</button>
                <button class="btn btn-gray" onclick="fecharModais()" style="flex:1">Voltar</button>
            </div>
        </div>
    </div>

    <div id="modal-input" class="modal">
        <div class="modal-content">
            <h2 id="modal-input-titulo">T√≠tulo</h2>
            <input type="text" id="modal-input-campo">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-green" id="btn-modal-confirmar" style="flex:1">OK</button>
                <button class="btn btn-gray" onclick="fecharModais()" style="flex:1">Sair</button>
            </div>
        </div>
    </div>

    <aside id="sidebar">
        <div class="header-box">
            <h3 id="op-nome">CAIXA FECHADO</h3>
            <button class="btn btn-red" id="btn-turno-acao" style="width:100%" onclick="abrirTurnoCustom()">Abrir Turno</button>
        </div>
        <div style="padding: 15px;"><button class="btn btn-pink" style="width: 100%;" onclick="novaComandaCustom()">+ Nova Comanda</button></div>
        <div id="lista-comandas"></div>
    </aside>

    <main id="workspace">
        <div id="view-comanda">
            <div class="top-bar">
                <h2 id="titulo-cliente" style="margin:0; color: var(--pink-dark);"></h2>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-red" style="padding:8px" onclick="solicitarSenhaCancelamento()">‚ùå Cancelar</button>
                    <button class="btn btn-gray" style="padding:8px" onclick="minimizar()">üîí Sair</button>
                </div>
            </div>
            <div class="grid-produtos">
                <div class="card-prod" onclick="addPesoCustom()">‚öñÔ∏è PESO</div>
                <div class="card-prod" onclick="addItem('Picol√©', 5)">üçì PICOL√â</div>
                <div class="card-prod" onclick="addItem('Casc√£o', 15)">üç¶ CASC√ÉO</div>
                <div class="card-prod" onclick="addItem('√Ågua', 4)">üíß √ÅGUA</div>
            </div>
            <div id="detalhes-comanda">
                <div id="itens-carrinho"></div>
                <div class="footer-comanda">
                    <div class="display-total"><span>Total:</span><span id="total-venda">0,00</span></div>
                    <button class="btn btn-green" onclick="abrirPagamento()">Receber</button>
                </div>
            </div>
        </div>
        <div id="aviso-inicial" style="margin: auto; text-align: center; color: #b2bec3;"><h1>üç¶ PDV</h1><p>Selecione uma comanda.</p></div>
    </main>

    <div id="modal-pgto" class="modal">
        <div class="modal-content">
            <h2 id="pgto-total-txt">Total: R$ 0,00</h2>
            <select id="metodo" onchange="toggleDinheiro()">
                <option value="PIX">PIX</option>
                <option value="CART√ÉO">CART√ÉO</option>
                <option value="DINHEIRO">DINHEIRO</option>
            </select>
            <div id="secao-dinheiro" class="oculto">
                <input type="number" id="valor-recebido" placeholder="Valor Recebido" oninput="calcularTroco()">
                <p id="txt-troco" style="font-weight:bold; color:var(--green);">Troco: R$ 0,00</p>
            </div>
            <button class="btn btn-green" onclick="confirmarVenda()">Finalizar</button>
            <button class="btn btn-gray" style="width:100%; margin-top:5px;" onclick="fecharModais()">Voltar</button>
        </div>
    </div>

    <div id="relatorio-pdf" class="oculto"></div>

<script>
    const s_key = "0o5r1q3w4e1q"; 
    let db = JSON.parse(localStorage.getItem('sorv_final_pdf')) || { operador: "", inicio: "", vendas: [], comandas: [] };
    let comandaAtivaId = null;

    function salvar() { localStorage.setItem('sorv_final_pdf', JSON.stringify(db)); render(); }
    function fecharModais() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    function abrirModalInput(titulo, placeholder, callback) {
        document.getElementById('modal-input-titulo').innerText = titulo;
        const campo = document.getElementById('modal-input-campo');
        campo.placeholder = placeholder; campo.value = "";
        document.getElementById('modal-input').style.display = 'flex';
        document.getElementById('btn-modal-confirmar').onclick = () => { if(campo.value) { callback(campo.value); fecharModais(); } };
    }

    function abrirTurnoCustom() {
        if (!db.inicio) {
            abrirModalInput("Abrir Turno", "Nome do Operador", (nome) => {
                db.operador = nome; db.inicio = new Date().toLocaleString(); salvar();
            });
        } else {
            if (db.comandas.length > 0) return alert("Feche as comandas antes!");
            gerarRelatorioFinal();
        }
    }

    function novaComandaCustom() {
        if (!db.inicio) return alert("Abra o turno!");
        abrirModalInput("Nova Comanda", "Nome do Cliente", (nome) => {
            const nova = { id: Date.now(), cliente: nome, itens: [], total: 0 };
            db.comandas.push(nova); comandaAtivaId = nova.id; salvar();
        });
    }

    function addPesoCustom() {
        abrirModalInput("Peso (Gramas)", "Ex: 450", (g) => { addItem('Sorvete Kg', 85, parseFloat(g)); });
    }

    function addItem(n, v, g = null) {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        if (g) { v = (v/1000) * g; n += ` (${g}g)`; }
        c.itens.push({ n, v });
        c.total = c.itens.reduce((acc, i) => acc + i.v, 0);
        salvar();
    }

    function solicitarSenhaCancelamento() {
        document.getElementById('campo-senha-cancelar').value = "";
        document.getElementById('modal-senha').style.display = 'flex';
    }

    function validarCancelamento() {
        if (document.getElementById('campo-senha-cancelar').value === s_key.replace(/\D/g, "")) {
            db.comandas = db.comandas.filter(x => x.id !== comandaAtivaId);
            comandaAtivaId = null; fecharModais(); salvar();
        } else { alert("Senha Incorreta!"); }
    }

    function confirmarVenda() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        db.vendas.push({ cliente: c.cliente, total: c.total, metodo: document.getElementById('metodo').value, hora: new Date().toLocaleTimeString() });
        db.comandas = db.comandas.filter(x => x.id !== comandaAtivaId);
        comandaAtivaId = null; fecharModais(); salvar();
    }

    function gerarRelatorioFinal() {
        const relArea = document.getElementById('relatorio-pdf');
        relArea.classList.remove('oculto');
        
        let totalGeral = db.vendas.reduce((a, b) => a + b.total, 0);
        let resumoTexto = `*FECHAMENTO DE CAIXA*\nOp: ${db.operador}\nTotal: R$ ${totalGeral.toFixed(2)}\n\n`;

        let html = `<h2>RESUMO DE VENDAS</h2><p>Op: ${db.operador} | ${db.inicio}</p><hr><ul>`;
        db.vendas.forEach(v => {
            html += `<li>${v.cliente} - R$ ${v.total.toFixed(2)} (${v.metodo})</li>`;
            resumoTexto += `- ${v.cliente}: R$ ${v.total.toFixed(2)}\n`;
        });
        html += `</ul><hr><h3>TOTAL GERAL: R$ ${totalGeral.toFixed(2)}</h3>`;
        relArea.innerHTML = html;

        // Op√ß√£o 1: PDF (Funciona no Celular com a biblioteca)
        const opt = { margin: 1, filename: 'relatorio-caixa.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
        html2pdf().set(opt).from(relArea).save().then(() => {
            // Op√ß√£o 2: WhatsApp (Seguro de backup)
            if(confirm("PDF gerado! Deseja enviar o resumo por WhatsApp tamb√©m?")) {
                window.open(`https://wa.me/?text=${encodeURIComponent(resumoTexto)}`);
            }
            
            if(confirm("Deseja ZERAR o sistema para o pr√≥ximo turno?")) {
                db = { operador: "", inicio: "", vendas: [], comandas: [] };
                localStorage.removeItem('sorv_final_pdf');
                location.reload();
            }
        });
    }

    function render() {
        document.getElementById('op-nome').innerText = db.inicio ? `OP: ${db.operador}` : "CAIXA FECHADO";
        const lista = document.getElementById('lista-comandas');
        lista.innerHTML = "";
        db.comandas.forEach(c => {
            lista.innerHTML += `<div class="aba-comanda ${comandaAtivaId === c.id ? 'ativa' : ''}" onclick="comandaAtivaId=${c.id}; render();"><strong>${c.cliente}</strong><span>R$ ${c.total.toFixed(2)}</span></div>`;
        });
        const view = document.getElementById('view-comanda');
        const aviso = document.getElementById('aviso-inicial');
        if (comandaAtivaId) {
            view.style.display = "flex"; aviso.style.display = "none";
            const c = db.comandas.find(x => x.id === comandaAtivaId);
            document.getElementById('titulo-cliente').innerText = `üë§ ${c.cliente.toUpperCase()}`;
            document.getElementById('total-venda').innerText = c.total.toFixed(2).replace('.', ',');
            const itensDiv = document.getElementById('itens-carrinho');
            itensDiv.innerHTML = "";
            c.itens.forEach((it, idx) => { itensDiv.innerHTML += `<div class="item-row"><span>${it.n}</span><span>R$ ${it.v.toFixed(2)}</span></div>`; });
            itensDiv.scrollTop = itensDiv.scrollHeight;
        } else { view.style.display = "none"; aviso.style.display = "flex"; }
    }

    function abrirPagamento() { 
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        document.getElementById('pgto-total-txt').innerText = `Total: R$ ${c.total.toFixed(2)}`;
        document.getElementById('modal-pgto').style.display = 'flex'; 
    }
    function toggleDinheiro() { document.getElementById('secao-dinheiro').classList.toggle('oculto', document.getElementById('metodo').value !== "DINHEIRO"); }
    function calcularTroco() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        const rec = parseFloat(document.getElementById('valor-recebido').value) || 0;
        document.getElementById('txt-troco').innerText = `Troco: R$ ${Math.max(0, rec - c.total).toFixed(2)}`;
    }
    function minimizar() { comandaAtivaId = null; render(); }

    render();
</script>
</body>
</html>
