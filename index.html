<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sorveteria PRO - Mobile Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --pink: #ff85a2; --pink-dark: #ef6281; --blue: #0984e3; --green: #27ae60;
            --dark: #2d3436; --gray-bg: #f5f6fa; --border: #dcdde1; --white: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; 
            height: 100vh; background-color: var(--gray-bg); color: var(--dark); 
            overflow: hidden; /* Impede a p√°gina inteira de rolar */
        }

        /* Sidebar - No mobile ela precisa ser ajustada */
        #sidebar { 
            width: 300px; background: var(--white); border-right: 2px solid var(--border); 
            display: flex; flex-direction: column; flex-shrink: 0;
        }

        .header-box { padding: 15px; background: var(--dark); color: white; text-align: center; }
        #lista-comandas { flex-grow: 1; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        
        .aba-comanda { 
            padding: 12px; background: white; border: 1px solid var(--border); border-radius: 8px; 
            margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .aba-comanda.ativa { border-left: 6px solid var(--pink); background: #fff5f7; border-color: var(--pink); }

        /* Workspace Principal */
        #workspace { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        #view-comanda { 
            display: none; flex-direction: column; height: 100%; 
            padding: 10px; background: var(--gray-bg);
        }

        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; gap: 5px; flex-shrink: 0;
        }

        .grid-produtos { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; 
            margin-bottom: 10px; flex-shrink: 0;
        }
        
        .card-prod { 
            background: white; padding: 12px 5px; border-radius: 10px; text-align: center; 
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; 
            font-weight: bold; font-size: 0.85rem;
        }

        /* Container de Itens e Bot√£o de Finalizar */
        #detalhes-comanda { 
            background: white; border-radius: 15px 15px 0 0; border: 1px solid var(--border); 
            display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; 
            position: relative;
        }

        #itens-carrinho { 
            flex-grow: 1; overflow-y: auto; padding: 15px; 
            background: #fafafa; margin-bottom: 80px; /* Espa√ßo para o bot√£o fixo */
        }

        .item-row { 
            display: flex; justify-content: space-between; padding: 10px 0; 
            border-bottom: 1px solid #eee; font-size: 0.95rem;
        }

        /* Rodap√© FIXO na Comanda */
        .footer-comanda { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 10px 15px; background: white; border-top: 2px solid #eee; 
            box-shadow: 0 -3px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 5px;
        }

        .display-total { 
            font-size: 1.5rem; font-weight: 800; display: flex; 
            justify-content: space-between; color: var(--dark);
        }

        /* Bot√µes */
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }
        .btn-pink { background: var(--pink); color: white; }
        .btn-green { background: var(--green); color: white; width: 100%; font-size: 1rem; }
        .btn-red { background: #ff7675; color: white; }
        .btn-gray { background: #dfe6e9; color: var(--dark); }

        /* Modais Responsivos */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 350px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; }

        .oculto { display: none; }

        /* Ajuste para telas muito pequenas */
        @media (max-width: 600px) {
            #sidebar { width: 80px; }
            #sidebar .header-box h3, #sidebar .btn, .aba-comanda strong { display: none; }
            .aba-comanda { justify-content: center; padding: 15px 5px; }
            .aba-comanda span { font-size: 0.7rem; font-weight: bold; }
        }
    </style>
</head>
<body>

    <div id="modal-senha" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Senha de Gerente</h3>
            <input type="password" id="campo-senha-cancelar" placeholder="Digite a senha">
            <button class="btn btn-red" style="width:100%" onclick="validarCancelamento()">Confirmar Cancelar</button>
            <button class="btn btn-gray" style="width:100%; margin-top:10px" onclick="fecharModais()">Voltar</button>
        </div>
    </div>

    <div id="modal-input" class="modal">
        <div class="modal-content">
            <h3 id="modal-input-titulo">Entrada</h3>
            <input type="text" id="modal-input-campo">
            <button class="btn btn-green" id="btn-modal-confirmar" style="width:100%">Confirmar</button>
            <button class="btn btn-gray" style="width:100%; margin-top:10px" onclick="fecharModais()">Sair</button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="header-box">
            <h4 id="op-nome" style="margin:0 0 10px 0; font-size: 0.7rem;">FECHADO</h4>
            <button class="btn btn-green" id="btn-turno-acao" style="width:100%" onclick="controleTurno()">Abrir Turno</button>
        </div>
        <div style="padding: 10px;"><button class="btn btn-pink" style="width:100%" onclick="novaComandaCustom()">+</button></div>
        <div id="lista-comandas"></div>
    </aside>

    <main id="workspace">
        <div id="view-comanda">
            <div class="top-bar">
                <strong id="titulo-cliente" style="font-size: 1rem; color: var(--pink-dark);"></strong>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-red" style="padding:5px 10px" onclick="solicitarSenhaCancelamento()">‚ùå</button>
                    <button class="btn btn-gray" style="padding:5px 10px" onclick="minimizar()">üîí</button>
                </div>
            </div>
            
            <div class="grid-produtos">
                <div class="card-prod" onclick="addPesoCustom()">‚öñÔ∏è PESO</div>
                <div class="card-prod" onclick="addItem('Picol√©', 5)">üçì PICOL√â</div>
                <div class="card-prod" onclick="addItem('Casc√£o', 15)">üç¶ CASC√ÉO</div>
                <div class="card-prod" onclick="addItem('√Ågua', 4)">üíß √ÅGUA</div>
            </div>

            <div id="detalhes-comanda">
                <div id="itens-carrinho"></div>
                <div class="footer-comanda">
                    <div class="display-total"><span>Total:</span><span id="total-venda">0,00</span></div>
                    <button class="btn btn-green" onclick="abrirPagamento()">FINALIZAR VENDA</button>
                </div>
            </div>
        </div>
        <div id="aviso-inicial" style="margin: auto; text-align: center; color: #ccc;">
            <h2>üç¶ PDV</h2><p>Selecione uma comanda ao lado.</p>
        </div>
    </main>

    <div id="modal-pgto" class="modal">
        <div class="modal-content">
            <h3 id="pgto-total-txt">R$ 0,00</h3>
            <select id="metodo" onchange="toggleDinheiro()">
                <option value="PIX">PIX</option>
                <option value="CART√ÉO">CART√ÉO</option>
                <option value="DINHEIRO">DINHEIRO</option>
            </select>
            <div id="secao-dinheiro" class="oculto">
                <input type="number" id="valor-recebido" placeholder="Recebido" oninput="calcularTroco()">
                <p id="txt-troco" style="font-weight:bold; color:var(--green); margin:5px 0;">Troco: R$ 0,00</p>
            </div>
            <button class="btn btn-green" style="width:100%" onclick="confirmarVenda()">CONCLUIR</button>
            <button class="btn btn-gray" style="width:100%; margin-top:10px;" onclick="fecharModais()">VOLTAR</button>
        </div>
    </div>

    <div id="relatorio-pdf" class="oculto"></div>

<script>
    const s_key = "0o5r1q3w4e1q"; 
    let db = JSON.parse(localStorage.getItem('sorv_v7_final')) || { operador: "", inicio: "", vendas: [], comandas: [] };
    let comandaAtivaId = null;

    function salvar() { localStorage.setItem('sorv_v7_final', JSON.stringify(db)); render(); }
    function fecharModais() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    // BOT√ÉO DE TURNO CORRIGIDO
    function controleTurno() {
        if (!db.inicio) {
            abrirModalInput("Nome do Operador", "Nome", (nome) => {
                db.operador = nome; db.inicio = new Date().toLocaleString(); 
                salvar();
            });
        } else {
            if (db.comandas.length > 0) return alert("Existem comandas abertas!");
            if (confirm("Deseja fechar o turno e gerar o PDF?")) gerarRelatorioFinal();
        }
    }

    function abrirModalInput(titulo, placeholder, callback) {
        document.getElementById('modal-input-titulo').innerText = titulo;
        const campo = document.getElementById('modal-input-campo');
        campo.placeholder = placeholder; campo.value = "";
        document.getElementById('modal-input').style.display = 'flex';
        document.getElementById('btn-modal-confirmar').onclick = () => { if(campo.value) { callback(campo.value); fecharModais(); } };
    }

    function novaComandaCustom() {
        if (!db.inicio) return alert("Abra o turno primeiro!");
        abrirModalInput("Nova Comanda", "Nome do Cliente", (nome) => {
            const nova = { id: Date.now(), cliente: nome, itens: [], total: 0 };
            db.comandas.push(nova); comandaAtivaId = nova.id; salvar();
        });
    }

    function addItem(n, v, g = null) {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        if (g) { v = (v/1000) * g; n += ` (${g}g)`; }
        c.itens.push({ n, v });
        c.total = c.itens.reduce((acc, i) => acc + i.v, 0);
        salvar();
    }

    function addPesoCustom() { abrirModalInput("Peso (g)", "Ex: 450", (g) => addItem('Peso', 85, parseFloat(g))); }

    function solicitarSenhaCancelamento() { document.getElementById('modal-senha').style.display = 'flex'; }
    function validarCancelamento() {
        if (document.getElementById('campo-senha-cancelar').value === s_key.replace(/\D/g, "")) {
            db.comandas = db.comandas.filter(x => x.id !== comandaAtivaId);
            comandaAtivaId = null; fecharModais(); salvar();
        } else { alert("Senha Incorreta!"); }
    }

    function confirmarVenda() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        db.vendas.push({ cliente: c.cliente, total: c.total, metodo: document.getElementById('metodo').value, hora: new Date().toLocaleTimeString() });
        db.comandas = db.comandas.filter(x => x.id !== comandaAtivaId);
        comandaAtivaId = null; fecharModais(); salvar();
    }

    function gerarRelatorioFinal() {
        const relArea = document.getElementById('relatorio-pdf');
        relArea.classList.remove('oculto');
        let total = db.vendas.reduce((a, b) => a + b.total, 0);
        let html = `<h2>RELAT√ìRIO: ${db.operador}</h2><p>${db.inicio}</p><hr>`;
        db.vendas.forEach(v => html += `<p>${v.hora} - ${v.cliente}: R$ ${v.total.toFixed(2)} (${v.metodo})</p>`);
        html += `<hr><h3>TOTAL: R$ ${total.toFixed(2)}</h3>`;
        relArea.innerHTML = html;

        html2pdf().from(relArea).save('caixa.pdf').then(() => {
            db = { operador: "", inicio: "", vendas: [], comandas: [] };
            localStorage.removeItem('sorv_v7_final');
            location.reload();
        });
    }

    function render() {
        // Atualiza Bot√£o Turno
        const btnTurno = document.getElementById('btn-turno-acao');
        const opTxt = document.getElementById('op-nome');
        if(db.inicio) {
            btnTurno.innerText = "FECHAR TURNO";
            btnTurno.className = "btn btn-red";
            opTxt.innerText = `OP: ${db.operador}`;
        } else {
            btnTurno.innerText = "ABRIR TURNO";
            btnTurno.className = "btn btn-green";
            opTxt.innerText = "CAIXA FECHADO";
        }

        const lista = document.getElementById('lista-comandas');
        lista.innerHTML = "";
        db.comandas.forEach(c => {
            lista.innerHTML += `<div class="aba-comanda ${comandaAtivaId === c.id ? 'ativa' : ''}" onclick="comandaAtivaId=${c.id}; render();"><span>R$ ${c.total.toFixed(2)}</span><strong>${c.cliente}</strong></div>`;
        });

        if (comandaAtivaId) {
            document.getElementById('view-comanda').style.display = "flex";
            document.getElementById('aviso-inicial').style.display = "none";
            const c = db.comandas.find(x => x.id === comandaAtivaId);
            document.getElementById('titulo-cliente').innerText = `üë§ ${c.cliente}`;
            document.getElementById('total-venda').innerText = c.total.toFixed(2);
            const itensDiv = document.getElementById('itens-carrinho');
            itensDiv.innerHTML = "";
            c.itens.forEach(it => { itensDiv.innerHTML += `<div class="item-row"><span>${it.n}</span><span>R$ ${it.v.toFixed(2)}</span></div>`; });
            itensDiv.scrollTop = itensDiv.scrollHeight;
        } else {
            document.getElementById('view-comanda').style.display = "none";
            document.getElementById('aviso-inicial').style.display = "flex";
        }
    }

    function abrirPagamento() { 
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        document.getElementById('pgto-total-txt').innerText = `R$ ${c.total.toFixed(2)}`;
        document.getElementById('modal-pgto').style.display = 'flex'; 
    }
    function toggleDinheiro() { document.getElementById('secao-dinheiro').classList.toggle('oculto', document.getElementById('metodo').value !== "DINHEIRO"); }
    function calcularTroco() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        const rec = parseFloat(document.getElementById('valor-recebido').value) || 0;
        document.getElementById('txt-troco').innerText = `Troco: R$ ${Math.max(0, rec - c.total).toFixed(2)}`;
    }
    function minimizar() { comandaAtivaId = null; render(); }

    render();
</script>
</body>
</html>
