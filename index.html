<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorveteria PRO - Seguran√ßa Total</title>
    <style>
        :root {
            --pink: #ff85a2; --pink-dark: #ef6281; --blue: #0984e3; --green: #27ae60;
            --dark: #2d3436; --gray-bg: #f5f6fa; --border: #dcdde1; --white: #ffffff;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--gray-bg); color: var(--dark); overflow: hidden; }

        /* Barra Lateral */
        #sidebar { width: 350px; background: var(--white); border-right: 2px solid var(--border); display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.05); z-index: 10; }
        .header-box { padding: 20px; background: var(--dark); color: white; text-align: center; }
        #lista-comandas { flex-grow: 1; overflow-y: auto; padding: 15px; }
        
        .aba-comanda { 
            padding: 15px; background: white; border: 1px solid var(--border); border-radius: 10px; 
            margin-bottom: 12px; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .aba-comanda.ativa { border-left: 10px solid var(--pink); background: #fff5f7; border-color: var(--pink); }

        /* √Årea Principal */
        #workspace { flex-grow: 1; display: flex; flex-direction: column; padding: 25px; height: 100vh; }
        #view-comanda { display: none; flex-direction: column; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; gap: 10px; }
        
        .grid-produtos { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .card-prod { background: white; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; transition: 0.2s; font-weight: bold; }
        .card-prod:hover { border-color: var(--pink); background: #fff9fa; }

        /* Cont√™iner da Conta */
        #detalhes-comanda { background: white; border-radius: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        #itens-carrinho { flex-grow: 1; overflow-y: auto; padding: 20px; background: #fafafa; }
        .item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }

        .footer-comanda { padding: 20px; background: white; border-top: 2px solid #f1f1f1; flex-shrink: 0; }
        .display-total { font-size: 2.2rem; font-weight: 800; display: flex; justify-content: space-between; margin-bottom: 15px; }

        /* Bot√µes */
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; }
        .btn-pink { background: var(--pink); color: white; }
        .btn-green { background: var(--green); color: white; width: 100%; font-size: 1.2rem; }
        .btn-red { background: #ff7675; color: white; }
        .btn-gray { background: #dfe6e9; color: var(--dark); }

        /* Modais */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: pop 0.3s ease; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        input, select { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; }

        #relatorio-area { display: none; padding: 50px; font-family: monospace; }
        @media print { body * { visibility: hidden; } #relatorio-area, #relatorio-area * { visibility: visible; } #relatorio-area { display: block; position: absolute; left: 0; top: 0; } }
    </style>
</head>
<body>

    <div id="modal-senha" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--pink-dark); margin-top:0;">üîí Autoriza√ß√£o</h2>
            <p>Digite a senha de gerente para <strong>CANCELAR</strong> esta comanda:</p>
            <input type="password" id="campo-senha-cancelar" placeholder="Senha do Gerente">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-red" onclick="validarCancelamento()" style="flex:1">Confirmar</button>
                <button class="btn btn-gray" onclick="fecharModais()" style="flex:1">Voltar</button>
            </div>
        </div>
    </div>

    <div id="modal-input" class="modal">
        <div class="modal-content">
            <h2 id="modal-input-titulo" style="color: var(--pink-dark); margin-top:0;">T√≠tulo</h2>
            <p id="modal-input-desc"></p>
            <input type="text" id="modal-input-campo">
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-green" id="btn-modal-confirmar" style="flex:1">Confirmar</button>
                <button class="btn btn-gray" onclick="fecharModalInput()" style="flex:1">Cancelar</button>
            </div>
        </div>
    </div>

    <aside id="sidebar">
        <div class="header-box">
            <h3 id="op-nome">CAIXA FECHADO</h3>
            <button class="btn btn-red" id="btn-turno-acao" style="width:100%" onclick="abrirTurnoCustom()">Abrir Turno</button>
        </div>
        <div style="padding: 20px;">
            <button class="btn btn-pink" style="width: 100%;" onclick="novaComandaCustom()">+ Nova Comanda</button>
        </div>
        <div id="lista-comandas"></div>
    </aside>

    <main id="workspace">
        <div id="view-comanda">
            <div class="top-bar">
                <h1 id="titulo-cliente" style="margin:0; color: var(--pink-dark); flex-grow:1;"></h1>
                <button class="btn btn-red" onclick="solicitarSenhaCancelamento()">‚ùå Cancelar Conta</button>
                <button class="btn btn-gray" onclick="minimizar()">üîí Minimizar</button>
            </div>

            <div class="grid-produtos">
                <div class="card-prod" onclick="addPesoCustom()">‚öñÔ∏è PESO<small>R$ 85,00/kg</small></div>
                <div class="card-prod" onclick="addItem('Picol√© Fruta', 5)">üçì PICOL√â<small>R$ 5,00</small></div>
                <div class="card-prod" onclick="addItem('Milkshake', 20)">ü•§ MILKSHAKE<small>R$ 20,00</small></div>
                <div class="card-prod" onclick="addItem('√Ågua Mineral', 4)">üíß √ÅGUA<small>R$ 4,00</small></div>
            </div>

            <div id="detalhes-comanda">
                <div id="itens-carrinho"></div>
                <div class="footer-comanda">
                    <div class="display-total">
                        <span>Total:</span>
                        <span>R$ <span id="total-venda">0,00</span></span>
                    </div>
                    <button class="btn btn-green" onclick="abrirPagamento()">Finalizar e Receber</button>
                </div>
            </div>
        </div>

        <div id="aviso-inicial" style="margin: auto; text-align: center; color: #b2bec3;">
            <span style="font-size: 80px;">üç¶</span>
            <h1>Sorveteria Professional</h1>
            <p>Selecione ou crie uma comanda lateral para come√ßar.</p>
        </div>
    </main>

    <div id="modal-pgto" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Pagamento</h2>
            <div style="background: var(--gray-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <strong style="font-size: 2rem;" id="pgto-total-txt">R$ 0,00</strong>
            </div>
            <select id="metodo" onchange="toggleDinheiro()">
                <option value="PIX">PIX</option>
                <option value="CART√ÉO D√âBITO">CART√ÉO D√âBITO</option>
                <option value="CART√ÉO CR√âDITO">CART√ÉO CR√âDITO</option>
                <option value="DINHEIRO">DINHEIRO</option>
            </select>
            <div id="secao-dinheiro" style="display: none; border: 2px solid var(--green); padding: 15px; border-radius: 10px; margin-top: 10px;">
                <label>Valor Recebido:</label>
                <input type="number" id="valor-recebido" placeholder="0.00" oninput="calcularTroco()">
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: var(--green);">
                    <span>TROCO:</span><span id="txt-troco">R$ 0,00</span>
                </div>
            </div>
            <button class="btn btn-green" style="margin-top: 20px;" onclick="confirmarVenda()">Confirmar Venda</button>
            <button class="btn btn-gray" style="width: 100%; margin-top: 10px;" onclick="fecharModais()">Voltar</button>
        </div>
    </div>

    <div id="relatorio-area"></div>

<script>
    // A SENHA EST√Å AQUI
    const s_key = "0o5r1q3w4e1q"; 

    let db = JSON.parse(localStorage.getItem('sorv_safe_v6')) || { operador: "", inicio: "", vendas: [], comandas: [] };
    let comandaAtivaId = null;

    // Utilit√°rios de Modal
    function abrirModalInput(titulo, desc, placeholder, callback) {
        document.getElementById('modal-input-titulo').innerText = titulo;
        document.getElementById('modal-input-desc').innerText = desc;
        const campo = document.getElementById('modal-input-campo');
        campo.placeholder = placeholder; campo.value = "";
        document.getElementById('modal-input').style.display = 'flex';
        campo.focus();
        document.getElementById('btn-modal-confirmar').onclick = () => { if(campo.value) { callback(campo.value); fecharModalInput(); } };
    }
    function fecharModalInput() { document.getElementById('modal-input').style.display = 'none'; }
    function fecharModais() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    // Gerenciamento de Senha de Cancelamento
    function solicitarSenhaCancelamento() {
        document.getElementById('campo-senha-cancelar').value = "";
        document.getElementById('modal-senha').style.display = 'flex';
        document.getElementById('campo-senha-cancelar').focus();
    }

    function validarCancelamento() {
        const input = document.getElementById('campo-senha-cancelar').value;
        const cleanKey = s_key.replace(/\D/g, ""); // Extrai "051341" da string codificada

        if (input === cleanKey) {
            db.comandas = db.comandas.filter(x => x.id !== comandaAtivaId);
            comandaAtivaId = null;
            fecharModais();
            salvar();
            alert("Comanda cancelada com sucesso.");
        } else {
            alert("‚ö†Ô∏è Senha incorreta! Cancelamento n√£o autorizado.");
        }
    }

    // Fluxo de Turno e Comanda
    function abrirTurnoCustom() {
        if (!db.inicio) {
            abrirModalInput("Abrir Caixa", "Nome do operador:", "Nome", (nome) => {
                db.operador = nome; db.inicio = new Date().toLocaleString(); salvar();
            });
        } else {
            if (db.comandas.length > 0) return alert("Feche as comandas abertas!");
            gerarRelatorio();
        }
    }

    function novaComandaCustom() {
        if (!db.inicio) return alert("Abra o turno!");
        abrirModalInput("Nova Comanda", "Nome do Cliente/Mesa:", "Ex: Mesa 10", (nome) => {
            const nova = { id: Date.now(), cliente: nome, itens: [], total: 0 };
            db.comandas.push(nova);
            comandaAtivaId = nova.id; salvar();
        });
    }

    function addPesoCustom() {
        abrirModalInput("Peso", "Gramas registradas:", "Ex: 400", (g) => { addItem('Sorvete Kg', 85, parseFloat(g)); });
    }

    function addItem(n, v, g = null) {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        if (g) { v = (v/1000) * g; n += ` (${g}g)`; }
        c.itens.push({ n, v });
        c.total = c.itens.reduce((acc, i) => acc + i.v, 0);
        salvar();
    }

    function removeItem(idx) {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        c.itens.splice(idx, 1);
        c.total = c.itens.reduce((acc, i) => acc + i.v, 0);
        salvar();
    }

    function salvar() { localStorage.setItem('sorv_safe_v6', JSON.stringify(db)); render(); }
    function minimizar() { comandaAtivaId = null; render(); }

    function render() {
        document.getElementById('op-nome').innerText = db.inicio ? `OP: ${db.operador}` : "CAIXA FECHADO";
        const btn = document.getElementById('btn-turno-acao');
        btn.innerText = db.inicio ? "Fechar Turno" : "Abrir Turno";
        btn.style.background = db.inicio ? "#ff7675" : "#27ae60";

        const lista = document.getElementById('lista-comandas');
        lista.innerHTML = "";
        db.comandas.forEach(c => {
            lista.innerHTML += `
                <div class="aba-comanda ${comandaAtivaId === c.id ? 'ativa' : ''}" onclick="comandaAtivaId=${c.id}; render();">
                    <strong>${c.cliente.toUpperCase()}</strong><span>R$ ${c.total.toFixed(2)}</span>
                </div>`;
        });

        const view = document.getElementById('view-comanda');
        const aviso = document.getElementById('aviso-inicial');
        if (comandaAtivaId) {
            view.style.display = "flex"; aviso.style.display = "none";
            const c = db.comandas.find(x => x.id === comandaAtivaId);
            document.getElementById('titulo-cliente').innerText = `üë§ ${c.cliente.toUpperCase()}`;
            document.getElementById('total-venda').innerText = c.total.toFixed(2).replace('.', ',');
            const itensDiv = document.getElementById('itens-carrinho');
            itensDiv.innerHTML = "";
            c.itens.forEach((it, idx) => {
                itensDiv.innerHTML += `
                <div class="item-row">
                    <span>${it.n}</span>
                    <span>R$ ${it.v.toFixed(2)} <button style="color:red; border:none; background:none; cursor:pointer;" onclick="removeItem(${idx})">‚úñ</button></span>
                </div>`;
            });
            itensDiv.scrollTop = itensDiv.scrollHeight;
        } else { view.style.display = "none"; aviso.style.display = "flex"; }
    }

    function abrirPagamento() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        document.getElementById('pgto-total-txt').innerText = `R$ ${c.total.toFixed(2).replace('.', ',')}`;
        document.getElementById('modal-pgto').style.display = 'flex';
    }

    function confirmarVenda() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        db.vendas.push({ cliente: c.cliente, total: c.total, metodo: document.getElementById('metodo').value, hora: new Date().toLocaleTimeString() });
        db.comandas = db.comandas.filter(x => x.id !== comandaAtivaId);
        comandaAtivaId = null; fecharModais(); salvar();
    }

    function toggleDinheiro() { document.getElementById('secao-dinheiro').style.display = (document.getElementById('metodo').value === "DINHEIRO") ? 'block' : 'none'; }
    function calcularTroco() {
        const c = db.comandas.find(x => x.id === comandaAtivaId);
        const rec = parseFloat(document.getElementById('valor-recebido').value) || 0;
        document.getElementById('txt-troco').innerText = `R$ ${Math.max(0, rec - c.total).toFixed(2).replace('.', ',')}`;
    }

    function gerarRelatorio() {
        const area = document.getElementById('relatorio-area');
        let html = `<h1>RELAT√ìRIO DE VENDAS</h1><p>Operador: ${db.operador}</p><hr>`;
        db.vendas.forEach(v => { html += `<p>${v.cliente} | ${v.metodo} | R$ ${v.total.toFixed(2)} √†s ${v.hora}</p>`; });
        area.innerHTML = html; window.print();
        db = { operador: "", inicio: "", vendas: [], comandas: [] }; salvar(); location.reload();
    }

    render();
</script>
</body>
</html>